{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dicom_viewer_3d.css' %}">
<style>
    .page-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid #00ff66;
    }
    
    .page-header h1 {
        margin: 0;
        color: #00ff66;
        font-size: 24px;
        font-weight: 700;
    }
    
    .page-header p {
        margin: 5px 0 0;
        color: #888;
        font-size: 14px;
    }
    
    .question-panel {
        background: #1a1a1a;
        padding: 24px;
        border-radius: 12px;
        border: 2px solid #333;
        margin-bottom: 20px;
    }
    
    .question-text {
        color: #fff;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
    }
    
    .instruction-box {
        background: rgba(0, 255, 102, 0.05);
        border-left: 3px solid #00ff66;
        border-radius: 4px;
        padding: 12px;
        color: #888;
        font-size: 14px;
        margin-bottom: 20px;
    }
    
    .instruction-box strong {
        color: #00ff66;
    }
    
    .viewer-wrapper {
        width: 100%;
        height: 700px;
        margin-bottom: 20px;
    }
    
    .timer-display {
        background: rgba(0, 0, 0, 0.8);
        padding: 12px 20px;
        border-radius: 8px;
        border: 2px solid #00ff66;
    }
    
    .timer-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
    }
    
    .timer-value {
        font-size: 28px;
        font-weight: 700;
        color: #00ff66;
        font-family: 'Courier New', monospace;
    }
    
    .timer-value.warning {
        color: #ffaa00;
    }
    
    .timer-value.danger {
        color: #ff0000;
        animation: timerPulse 1s infinite;
    }
    
    @keyframes timerPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .feedback-panel {
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    
    .feedback-panel.correct {
        background: rgba(0, 255, 0, 0.1);
        border: 2px solid #00ff00;
        color: #00ff00;
        display: block;
    }
    
    .feedback-panel.incorrect {
        background: rgba(255, 0, 0, 0.1);
        border: 2px solid #ff0000;
        color: #ff6666;
        display: block;
    }
    
    .feedback-panel.info {
        background: rgba(0, 255, 102, 0.1);
        border: 2px solid #00ff66;
        color: #00ff66;
        display: block;
    }
    
    .action-buttons {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    
    .btn {
        padding: 12px 32px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-back {
        background: #333;
        color: #00ff66;
        border: 2px solid #00ff66;
    }
    
    .btn-back:hover {
        background: #00ff66;
        color: #000;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
        color: #000;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 255, 102, 0.4);
    }
    
    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .explanation-box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #444;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
    }
    
    .explanation-box strong {
        color: #00ff66;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Cornerstone3D - Modern Medical Imaging Library -->
<script src="https://unpkg.com/@cornerstonejs/core@1.0.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@cornerstonejs/tools@1.0.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@cornerstonejs/dicom-image-loader@1.0.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@cornerstonejs/streaming-image-volume-loader@1.0.0/dist/index.umd.js"></script>

<!-- 3D MPR DICOM Viewer -->
<script src="{% static 'js/dicom_viewer_3d.js' %}"></script>

<script>
let dicomViewer3D;
let selectedCoordinates = null;
let timerInterval = null;
let timeRemaining = {{ question.time_limit_seconds }};

document.addEventListener('DOMContentLoaded', async function() {
    console.log('Initializing 3D DICOM Viewer...');
    
    // Hotspot regions from question data
    const hotspotRegions = {{ question.hotspot_coordinates|safe }};
    
    // Initialize 3D MPR viewer
    dicomViewer3D = new DICOMViewer3D(
        'dicomViewer',
        '{{ question.question_image.url }}',
        {
            enableHotspots: true,
            hotspotRegions: hotspotRegions || [],
            showCrosshairs: true,
            allowWindowLevel: true,
            allowPan: true,
            allowZoom: true,
            onCoordinateClick: function(coordinates, hitHotspot) {
                handleCoordinateClick(coordinates, hitHotspot);
            }
        }
    );
    
    // Initialize the viewer
    const initialized = await dicomViewer3D.initialize();
    
    if (!initialized) {
        console.error('Failed to initialize 3D DICOM viewer');
        showFeedback('error', 'Failed to load DICOM viewer. Please refresh the page.');
    } else {
        console.log('‚úì 3D DICOM Viewer ready');
    }
    
    // Start timer
    startTimer();
});

function handleCoordinateClick(coordinates, hitHotspot) {
    console.log('Clicked coordinates:', coordinates);
    console.log('Hit hotspot:', hitHotspot);
    
    selectedCoordinates = coordinates;
    
    // Show feedback based on training mode
    {% if show_feedback %}
    if (hitHotspot) {
        showFeedback('correct', `‚úì Correct! You identified: <strong>${hitHotspot.name || 'Target Structure'}</strong>`);
    } else {
        showFeedback('info', 'Click registered. Try again or submit your answer.');
    }
    {% else %}
    showFeedback('info', `Click registered in <strong>${coordinates.viewport.toUpperCase()}</strong> plane. Submit when ready.`);
    {% endif %}
    
    // Enable submit button
    document.getElementById('submitBtn').disabled = false;
}

function showFeedback(type, message) {
    const feedbackPanel = document.getElementById('feedback');
    feedbackPanel.className = 'feedback-panel ' + type;
    feedbackPanel.innerHTML = message;
}

function submitDICOMAnswer() {
    if (!selectedCoordinates) {
        alert('Please click on the image to select your answer first.');
        return;
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('question_id', {{ question.id }});
    formData.append('clicked_x', selectedCoordinates.world[0]);
    formData.append('clicked_y', selectedCoordinates.world[1]);
    formData.append('clicked_z', selectedCoordinates.world[2]);
    formData.append('viewport', selectedCoordinates.viewport);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // Submit answer
    fetch('{% url "submit_dicom_answer" attempt.id %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show result
            if (data.is_correct) {
                showFeedback('correct', '‚úì <strong>Correct!</strong> You identified the target anatomy accurately.');
            } else {
                showFeedback('incorrect', '‚úó <strong>Incorrect.</strong> The clicked region is not the target anatomy.');
            }
            
            // Update button
            submitBtn.textContent = 'Answer Submitted ‚úì';
            
            // Proceed to next question after 2 seconds
            setTimeout(() => {
                window.location.href = '{% url "take_test" attempt.id %}';
            }, 2000);
        } else {
            showFeedback('incorrect', 'Error: ' + (data.error || 'Failed to submit answer'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Answer ‚Üí';
        }
    })
    .catch(error => {
        console.error('Error submitting answer:', error);
        showFeedback('incorrect', 'Failed to submit answer. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Answer ‚Üí';
    });
}

function startTimer() {
    const timerDisplay = document.getElementById('timer');
    
    timerInterval = setInterval(() => {
        timeRemaining--;
        
        // Update display
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Color coding
        if (timeRemaining <= 10) {
            timerDisplay.classList.add('danger');
        } else if (timeRemaining <= 30) {
            timerDisplay.classList.add('warning');
        }
        
        // Time's up
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            showFeedback('incorrect', 'Time is up! Submitting answer...');
            
            // Auto-submit or move to next question
            setTimeout(() => {
                if (selectedCoordinates) {
                    submitDICOMAnswer();
                } else {
                    window.location.href = '{% url "take_test" attempt.id %}';
                }
            }, 1000);
        }
    }, 1000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    if (dicomViewer3D) {
        dicomViewer3D.destroy();
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

{% block title %}DICOM Question - {{ attempt.test.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="page-header">
        <div class="flex justify-between items-center">
            <div>
                <h1>üè• {{ question.topic.name }}</h1>
                <p>3D Multi-Planar DICOM Analysis</p>
            </div>
            <div class="timer-display">
                <div class="timer-label">Time Remaining</div>
                <div class="timer-value" id="timer">
                    {{ question.time_limit_seconds }}s
                </div>
            </div>
        </div>
    </div>
    
    <!-- Question Panel -->
    <div class="question-panel">
        <div class="question-text">
            {{ question.question_text }}
        </div>
        
        <div class="instruction-box">
            <strong>üìå Instructions:</strong>
            <ul style="margin: 8px 0 0 20px; padding: 0;">
                <li>Click on <strong>any of the three views</strong> (Axial, Sagittal, or Coronal) to identify the target anatomy</li>
                <li>Use <strong>mouse wheel</strong> to scroll through slices in each plane</li>
                <li>Use <strong>middle-click + drag</strong> to pan the image</li>
                <li>Use the <strong>control buttons</strong> to reset view or adjust window/level</li>
                <li>Click the <strong>Sync button</strong> to toggle crosshair synchronization</li>
            </ul>
        </div>
        
        {% if question.explanation and show_explanation %}
        <div class="explanation-box">
            <strong>üí° Hint:</strong> {{ question.explanation }}
        </div>
        {% endif %}
    </div>
    
    <!-- 3D MPR DICOM Viewer -->
    <div class="viewer-wrapper" id="dicomViewer"></div>
    
    <!-- Feedback Panel -->
    <div id="feedback" class="feedback-panel"></div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'take_test' attempt.id %}" class="btn btn-back">
            ‚Üê Back to Test
        </a>
        
        <button id="submitBtn"
                onclick="submitDICOMAnswer()" 
                disabled
                class="btn btn-submit">
            Submit Answer ‚Üí
        </button>
    </div>
</div>
{% endblock %}