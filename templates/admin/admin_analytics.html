{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    :root {
        --primary-color: #667eea;
        --primary-dark: #5a67d8;
        --secondary-color: #764ba2;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #3b82f6;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #2d3748;
    }
    
    .dashboard-wrapper {
        padding: 30px;
        max-width: 1600px;
        margin: 0 auto;
    }
    
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .page-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    /* Filters Section */
    .filters-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
    }
    
    .filters-section h3 {
        margin-bottom: 20px;
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        align-items: end;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .filter-group select {
        width: 100%;
        padding: 12px 16px;
        /* WHITE BACKGROUND WITH DARK TEXT */
        background-color: #ffffff !important;
        color: #1f2937 !important;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        /* Add dropdown arrow */
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23374151'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 40px;
    }

    .filter-group select:hover {
        border-color: #667eea;
        background-color: #f9fafb !important;
    }

    .filter-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: #ffffff !important;
    }

    .filter-group select option {
        background-color: #ffffff !important;
        color: #1f2937 !important;
        padding: 10px;
        font-weight: 500;
    }

    .filter-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        font-size: 0.95rem;
    }
    
    .filter-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .filter-group input[type="date"] {
        width: 100%;
        padding: 12px 16px;
        background-color: #ffffff;
        color: #1f2937;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .filter-group input[type="date"]:hover {
        border-color: #667eea;
        background-color: #f9fafb;
    }

    .filter-group input[type="date"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
        
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white !important;
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151 !important;
        border: 2px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
    }
    
    /* Action Bar */
    .action-bar {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 14px 28px;
        background: white;
        border: 2px solid #d1d5db;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: #374151 !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #9ca3af;
    }
    
    .action-btn.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white !important;
    }

    .action-btn.success:hover {
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Primary action buttons */
    .action-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white !important;
    }

    .action-btn.primary:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Secondary action buttons */
    .action-btn.secondary {
        background: white;
        border-color: #667eea;
        color: #667eea !important;
    }

    .action-btn.secondary:hover {
        background: #667eea;
        color: white !important;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .stat-card.blue { border-left-color: #3b82f6; }
    .stat-card.green { border-left-color: #10b981; }
    .stat-card.orange { border-left-color: #f59e0b; }
    .stat-card.purple { border-left-color: #8b5cf6; }
    .stat-card.red { border-left-color: #ef4444; }
    .stat-card.indigo { border-left-color: #667eea; }
    .stat-card.teal { border-left-color: #14b8a6; }
    .stat-card.pink { border-left-color: #ec4899; }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 5px;
    }
    
    .stat-card.blue .stat-value { color: #3b82f6; }
    .stat-card.green .stat-value { color: #10b981; }
    .stat-card.orange .stat-value { color: #f59e0b; }
    .stat-card.purple .stat-value { color: #8b5cf6; }
    .stat-card.red .stat-value { color: #ef4444; }
    .stat-card.indigo .stat-value { color: #667eea; }
    .stat-card.teal .stat-value { color: #14b8a6; }
    .stat-card.pink .stat-value { color: #ec4899; }
    
    .stat-description {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-top: 5px;
    }
    
    /* Analytics Section */
    .analytics-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .section-icon {
        font-size: 1.8rem;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }
    
    /* Recommendations */
    .recommendation-card {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 4px solid;
    }
    
    .recommendation-card.high {
        background: #fee2e2;
        border-left-color: #ef4444;
    }
    
    .recommendation-card.medium {
        background: #fef3c7;
        border-left-color: #f59e0b;
    }
    
    .recommendation-card.low {
        background: #dbeafe;
        border-left-color: #3b82f6;
    }
    
    .recommendation-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1rem;
    }
    
    .recommendation-detail {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 8px;
    }
    
    .recommendation-action {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    /* Charts */
    .chart-container {
        margin: 20px 0;
        text-align: center;
    }
    
    .chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }
    
    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
    }
    
    .data-table thead {
        background: #f9fafb;
    }
    
    .data-table th {
        padding: 14px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .data-table td {
        padding: 12px 14px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.95rem;
    }
    
    .data-table tr:hover {
        background: #f9fafb;
    }
    
    .data-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Distribution Grid */
    .distribution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .distribution-item {
        background: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
    }
    
    .distribution-item .label {
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .distribution-item .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    /* Badges */
    .badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge.excellent { background: #d1fae5; color: #065f46; }
    .badge.good { background: #d1f4ff; color: #065f46; }
    .badge.acceptable { background: #fef3c7; color: #92400e; }
    .badge.marginal { background: #fed7aa; color: #7c2d12; }
    .badge.poor { background: #fee2e2; color: #991b1b; }
    .badge.success { background: #d1fae5; color: #065f46; }
    .badge.danger { background: #fee2e2; color: #991b1b; }
    .badge.warning { background: #fef3c7; color: #92400e; }
    .badge.info { background: #dbeafe; color: #1e40af; }
    
    /* Score Display */
    .score-display {
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .score-display.excellent { color: #10b981; }
    .score-display.good { color: #3b82f6; }
    .score-display.average { color: #f59e0b; }
    .score-display.poor { color: #ef4444; }
    
    /* Progress Bars */
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .progress-fill.excellent { background: #10b981; }
    .progress-fill.good { background: #3b82f6; }
    .progress-fill.average { background: #f59e0b; }
    .progress-fill.poor { background: #ef4444; }
    
    /* Grid Layouts */
    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }
    
    .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #6b7280;
    }
    
    .empty-state p {
        font-size: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-wrapper {
            padding: 15px;
        }
        
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .stats-grid,
        .charts-grid,
        .grid-2 {
            grid-template-columns: 1fr;
        }
        
        .filter-actions,
        .action-bar {
            flex-direction: column;
        }
        
        .filter-form {
            grid-template-columns: 1fr;
        }

        .btn,
        .action-btn {
            width: 100%;
        }
    }
    
    /* Loading Animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(102, 126, 234, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üìä Comprehensive Analytics Dashboard</h1>
        <p>Complete insights for hiring, training, testing with all key statistics, visualizations, and actionable recommendations</p>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <h3>üîç Filter Analytics Data</h3>
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label for="test_id">Test</label>
                <select name="test_id" id="test_id">
                    <option value="">All Tests</option>
                    {% for test in available_tests %}
                    <option value="{{ test.id }}" {% if selected_test == test.id|stringformat:"s" %}selected{% endif %}>
                        {{ test.title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="cohort_id">Cohort</label>
                <select name="cohort_id" id="cohort_id">
                    <option value="">All Cohorts</option>
                    {% for cohort in available_cohorts %}
                    <option value="{{ cohort.id }}" {% if selected_cohort == cohort.id|stringformat:"s" %}selected{% endif %}>
                        {{ cohort.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="date_from">From Date</label>
                <input type="date" name="date_from" id="date_from" value="{{ date_from }}">
            </div>
            
            <div class="filter-group">
                <label for="date_to">To Date</label>
                <input type="date" name="date_to" id="date_to" value="{{ date_to }}">
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'admin_analytics' %}" class="btn btn-secondary">Clear</a>
            </div>
        </form>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <a href="{% url 'export_analytics_pdf' %}?{{ request.GET.urlencode }}" class="action-btn success">
            üìÑ Download PDF Report
        </a>
        <a href="{% url 'export_analytics' %}?{{ request.GET.urlencode }}" class="action-btn success">
            üì• Download Excel Report
        </a>
        <a href="{% url 'admin:assessment_testattempt_changelist' %}" class="action-btn secondary">
            üìã View All Attempts
        </a>
        <a href="{% url 'admin_dashboard_main' %}" class="action-btn secondary">
            ‚Üê Back to Dashboard
        </a>
    </div>
    
    <!-- Basic Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-label">Total Candidates</div>
            <div class="stat-value">{{ basic_stats.total_candidates|default:0 }}</div>
            <div class="stat-description">Unique test takers</div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-label">Total Attempts</div>
            <div class="stat-value">{{ basic_stats.total_attempts|default:0 }}</div>
            <div class="stat-description">Completed tests</div>
        </div>
        
        <div class="stat-card orange">
            <div class="stat-label">Pass Rate</div>
            <div class="stat-value">{{ basic_stats.pass_rate|default:0 }}%</div>
            <div class="stat-description">Success percentage</div>
        </div>
        
        <div class="stat-card purple">
            <div class="stat-label">Average Score</div>
            <div class="stat-value">{{ score_stats.average_score|default:0 }}%</div>
            <div class="stat-description">Mean performance</div>
        </div>
        
        <div class="stat-card red">
            <div class="stat-label">Median Score</div>
            <div class="stat-value">{{ score_stats.median_score|default:0 }}%</div>
            <div class="stat-description">Middle value</div>
        </div>
        
        <div class="stat-card indigo">
            <div class="stat-label">Std Deviation</div>
            <div class="stat-value">{{ score_stats.score_std_dev|default:0 }}</div>
            <div class="stat-description">Score variation</div>
        </div>
        
        <div class="stat-card teal">
            <div class="stat-label">Completion Rate</div>
            <div class="stat-value">{{ completion_stats.completion_rate|default:0 }}%</div>
            <div class="stat-description">Finished vs started</div>
        </div>
        
        <div class="stat-card pink">
            <div class="stat-label">Ready for Hiring</div>
            <div class="stat-value">{{ certification_ready_count|default:0 }}</div>
            <div class="stat-description">Certification ready</div>
        </div>
    </div>
    
    <!-- Actionable Recommendations -->
    {% if recommendations %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üéØ</span>
            <h2 class="section-title">Actionable Recommendations</h2>
        </div>
        
        {% for rec in recommendations %}
        <div class="recommendation-card {{ rec.priority }}">
            <div class="recommendation-title">
                {% if rec.priority == 'high' %}üî¥{% elif rec.priority == 'medium' %}üü°{% else %}üîµ{% endif %}
                {{ rec.title }}
            </div>
            <div class="recommendation-detail">{{ rec.detail }}</div>
            <div class="recommendation-action">üí° Action: {{ rec.action }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- ===== HIRING INSIGHTS ===== -->
    {% if top_performers %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üë®‚Äçüíº</span>
            <h2 class="section-title">Hiring Insights - Top Performers</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Candidate</th>
                    <th>Cohort</th>
                    <th>Tests Completed</th>
                    <th>Average Score</th>
                    <th>Latest Test</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for performer in top_performers %}
                <tr>
                    <td><strong>#{{ forloop.counter }}</strong></td>
                    <td>
                        <strong>{{ performer.user.get_full_name|default:performer.user.username }}</strong><br>
                        <small style="color: #6b7280;">{{ performer.user.email }}</small>
                    </td>
                    <td>{{ performer.cohort }}</td>
                    <td>{{ performer.tests_completed }}/4</td>
                    <td>
                        <span class="score-display excellent">{{ performer.avg_score|floatformat:1 }}%</span>
                        <div class="progress-bar">
                            <div class="progress-fill excellent" style="width: {{ performer.avg_score }}%;"></div>
                        </div>
                    </td>
                    <td>{{ performer.latest_test|date:"M d, Y" }}</td>
                    <td>
                        <span class="badge success">‚úì Ready to Hire</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Struggling Candidates -->
    {% if struggling_candidates %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">‚ö†Ô∏è</span>
            <h2 class="section-title">Candidates Needing Additional Training</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Candidate</th>
                    <th>Cohort</th>
                    <th>Tests Failed</th>
                    <th>Average Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in struggling_candidates %}
                <tr>
                    <td>
                        <strong>{{ candidate.user.get_full_name|default:candidate.user.username }}</strong><br>
                        <small style="color: #6b7280;">{{ candidate.user.email }}</small>
                    </td>
                    <td>{{ candidate.cohort }}</td>
                    <td>{{ candidate.failed_count }}/{{ candidate.total_attempts }}</td>
                    <td>
                        <span class="score-display poor">{{ candidate.avg_score|floatformat:1 }}%</span>
                    </td>
                    <td>
                        <span class="badge warning">‚ö† Needs Training</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Security Red Flags -->
    {% if red_flags %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üö®</span>
            <h2 class="section-title">Security & Integrity Issues</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Candidate</th>
                    <th>Test</th>
                    <th>Plagiarism Flag</th>
                    <th>Proctoring Issues</th>
                    <th>Date</th>
                    <th>Action Required</th>
                </tr>
            </thead>
            <tbody>
                {% for flag in red_flags %}
                <tr>
                    <td>
                        <strong>{{ flag.user.get_full_name|default:flag.user.username }}</strong>
                    </td>
                    <td>{{ flag.test }}</td>
                    <td>
                        {% if flag.plagiarism %}
                        <span class="badge danger">üö´ Flagged</span>
                        {% else %}
                        <span class="badge success">‚úì Clear</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if flag.proctoring_issues > 0 %}
                        <span class="badge danger">{{ flag.proctoring_issues }} Issues</span>
                        {% else %}
                        <span class="badge success">‚úì None</span>
                        {% endif %}
                    </td>
                    <td>{{ flag.date|date:"M d, Y" }}</td>
                    <td>
                        <span class="badge warning">‚ö† Review Required</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Score Analysis Section -->
    {% if score_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üìà</span>
            <h2 class="section-title">Score Analysis & Distribution</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-label">Highest Score</div>
                <div class="stat-value">{{ score_stats.highest_score }}%</div>
            </div>
            <div class="stat-card red">
                <div class="stat-label">Lowest Score</div>
                <div class="stat-value">{{ score_stats.lowest_score }}%</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">Score Range</div>
                <div class="stat-value">{{ score_stats.score_range }}</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">Top 10% Performers</div>
                <div class="stat-value">{{ score_stats.top_performers_count }}</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-label">Bottom 10% Performers</div>
                <div class="stat-value">{{ score_stats.weak_performers_count }}</div>
            </div>
        </div>
        
        {% if charts.score_distribution %}
        <div class="chart-container">
            <h3>Score Distribution by Range</h3>
            <img src="{{ charts.score_distribution }}" alt="Score Distribution">
        </div>
        {% endif %}
        
        {% if charts.pass_fail_pie %}
        <div class="chart-container">
            <h3>Pass/Fail Ratio</h3>
            <img src="{{ charts.pass_fail_pie }}" alt="Pass/Fail Distribution">
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- ===== TRAINING INSIGHTS ===== -->
    {% if cohort_performance %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üìö</span>
            <h2 class="section-title">Training Insights - Cohort Performance</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Cohort Name</th>
                    <th>Total Members</th>
                    <th>Tests Completed</th>
                    <th>Average Score</th>
                    <th>Pass Rate</th>
                    <th>Performance</th>
                </tr>
            </thead>
            <tbody>
                {% for cohort in cohort_performance %}
                <tr>
                    <td><strong>{{ cohort.name }}</strong></td>
                    <td>{{ cohort.total_members }}</td>
                    <td>{{ cohort.completed_tests }}</td>
                    <td>
                        <span class="score-display {% if cohort.avg_score >= 80 %}excellent{% elif cohort.avg_score >= 70 %}good{% elif cohort.avg_score >= 60 %}average{% else %}poor{% endif %}">
                            {{ cohort.avg_score|floatformat:1 }}%
                        </span>
                    </td>
                    <td>{{ cohort.pass_rate }}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill {% if cohort.avg_score >= 80 %}excellent{% elif cohort.avg_score >= 70 %}good{% elif cohort.avg_score >= 60 %}average{% else %}poor{% endif %}" 
                                 style="width: {{ cohort.avg_score }}%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Weak Topics -->
    {% if weak_topics %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üéØ</span>
            <h2 class="section-title">Topics Needing Training Focus</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Topic</th>
                    <th>Success Rate</th>
                    <th>Questions Asked</th>
                    <th>Priority</th>
                </tr>
            </thead>
            <tbody>
                {% for topic in weak_topics %}
                <tr>
                    <td><strong>{{ topic.topic }}</strong></td>
                    <td>
                        <span class="score-display poor">{{ topic.success_rate }}%</span>
                        <div class="progress-bar">
                            <div class="progress-fill poor" style="width: {{ topic.success_rate }}%;"></div>
                        </div>
                    </td>
                    <td>{{ topic.total_questions }}</td>
                    <td>
                        <span class="badge danger">üî¥ High Priority</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Time Analysis Section -->
    {% if time_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">‚è±Ô∏è</span>
            <h2 class="section-title">Time Analysis</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-label">Average Time</div>
                <div class="stat-value">{{ time_stats.average_time_minutes }} min</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Median Time</div>
                <div class="stat-value">{{ time_stats.median_time_minutes }} min</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">Minimum Time</div>
                <div class="stat-value">{{ time_stats.min_time_minutes }} min</div>
            </div>
            <div class="stat-card red">
                <div class="stat-label">Maximum Time</div>
                <div class="stat-value">{{ time_stats.max_time_minutes }} min</div>
            </div>
        </div>
        
        {% if time_stats.time_distribution %}
        <h3 style="margin-top: 30px;">Completion Time Distribution</h3>
        <div class="distribution-grid">
            <div class="distribution-item">
                <div class="label">Fast Finishers</div>
                <div class="value">{{ time_stats.time_distribution.fast }}</div>
            </div>
            <div class="distribution-item">
                <div class="label">Average Pace</div>
                <div class="value">{{ time_stats.time_distribution.average }}</div>
            </div>
            <div class="distribution-item">
                <div class="label">Slow Finishers</div>
                <div class="value">{{ time_stats.time_distribution.slow }}</div>
            </div>
        </div>
        
        {% if charts.time_distribution %}
        <div class="chart-container">
            <img src="{{ charts.time_distribution }}" alt="Time Distribution">
        </div>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Test Completion Time Analysis by Test -->
    {% if time_analysis %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">‚è±Ô∏è</span>
            <h2 class="section-title">Test Completion Time by Test</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Avg Time</th>
                    <th>Min Time</th>
                    <th>Max Time</th>
                    <th>Time Limit</th>
                    <th>Attempts</th>
                </tr>
            </thead>
            <tbody>
                {% for test in time_analysis %}
                <tr>
                    <td><strong>{{ test.test }}</strong></td>
                    <td>{{ test.avg_minutes }} min</td>
                    <td>{{ test.min_minutes }} min</td>
                    <td>{{ test.max_minutes }} min</td>
                    <td>{{ test.time_limit }} min</td>
                    <td>{{ test.attempts_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Section Performance -->
    {% if section_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üìö</span>
            <h2 class="section-title">Section-wise Performance Analysis</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Section Name</th>
                    <th>Average Score (%)</th>
                    <th>Pass Rate (%)</th>
                    <th>Attempts</th>
                    <th>Difficulty Index</th>
                    <th>Interpretation</th>
                </tr>
            </thead>
            <tbody>
                {% for section_name, stats in section_stats.items %}
                <tr>
                    <td><strong>{{ section_name }}</strong></td>
                    <td>{{ stats.average_score }}%</td>
                    <td>{{ stats.pass_rate }}%</td>
                    <td>{{ stats.attempts_count }}</td>
                    <td>{{ stats.difficulty_index }}</td>
                    <td><span class="badge {% if stats.difficulty_index < 40 %}good{% elif stats.difficulty_index < 60 %}acceptable{% else %}poor{% endif %}">{{ stats.interpretation }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if charts.section_performance %}
        <div class="chart-container">
            <img src="{{ charts.section_performance }}" alt="Section Performance">
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Stage Performance -->
    {% if category_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üìä</span>
            <h2 class="section-title">Performance by Stage</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Category</th>
                    <th>Attempts</th>
                    <th>Pass Rate</th>
                    <th>Avg Score</th>
                    <th>Avg Time</th>
                    <th>Passing Threshold</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in category_stats %}
                <tr>
                    <td><strong>Stage {{ cat.stage }}</strong></td>
                    <td>{{ cat.name }}</td>
                    <td>{{ cat.attempts }}</td>
                    <td>{{ cat.pass_rate }}%</td>
                    <td>
                        <span class="score-display {% if cat.avg_score >= 80 %}excellent{% elif cat.avg_score >= 70 %}good{% elif cat.avg_score >= 60 %}average{% else %}poor{% endif %}">
                            {{ cat.avg_score|floatformat:1 }}%
                        </span>
                    </td>
                    <td>{{ cat.avg_time_minutes }} min</td>
                    <td>{{ cat.passing_threshold }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Question Performance -->
    {% if question_stats.question_performance %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">‚ùì</span>
            <h2 class="section-title">Question Performance Analysis</h2>
        </div>
        
        <h3>Most Missed Questions (Hardest)</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Question ID</th>
                    <th>Question Text</th>
                    <th>Correct Rate (%)</th>
                    <th>Total Attempts</th>
                    <th>Difficulty Index</th>
                </tr>
            </thead>
            <tbody>
                {% for q in question_stats.most_missed_questions %}
                <tr>
                    <td>{{ q.question_id }}</td>
                    <td>{{ q.question_text }}...</td>
                    <td>{{ q.correct_rate }}%</td>
                    <td>{{ q.total_attempts }}</td>
                    <td><span class="badge poor">{{ q.difficulty_index }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if charts.question_difficulty %}
        <div class="chart-container">
            <img src="{{ charts.question_difficulty }}" alt="Question Difficulty">
        </div>
        {% endif %}
        
        <h3 style="margin-top: 40px;">Most Correctly Answered Questions (Easiest)</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Question ID</th>
                    <th>Question Text</th>
                    <th>Correct Rate (%)</th>
                    <th>Total Attempts</th>
                </tr>
            </thead>
            <tbody>
                {% for q in question_stats.most_correctly_answered %}
                <tr>
                    <td>{{ q.question_id }}</td>
                    <td>{{ q.question_text }}...</td>
                    <td><span class="badge excellent">{{ q.correct_rate }}%</span></td>
                    <td>{{ q.total_attempts }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if question_stats.discrimination_indices %}
        <h3 style="margin-top: 40px;">Item Discrimination Index</h3>
        <p style="color: #6b7280; margin-bottom: 15px;">Measures how well each question distinguishes between high and low performers</p>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Question Text</th>
                    <th>Discrimination Index</th>
                    <th>Interpretation</th>
                </tr>
            </thead>
            <tbody>
                {% for item in question_stats.discrimination_indices %}
                <tr>
                    <td>{{ item.question_text }}...</td>
                    <td>{{ item.discrimination_index }}</td>
                    <td>
                        <span class="badge {% if 'Excellent' in item.interpretation %}excellent{% elif 'Good' in item.interpretation %}good{% elif 'Acceptable' in item.interpretation %}acceptable{% elif 'Marginal' in item.interpretation %}marginal{% else %}poor{% endif %}">
                            {{ item.interpretation }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- ===== TESTING IMPROVEMENTS ===== -->
    <div class="grid-2">
        <!-- Too Easy Questions -->
        {% if too_easy_questions %}
        <div class="analytics-section">
            <div class="section-header">
                <span class="section-icon">üòä</span>
                <h2 class="section-title">Questions Too Easy</h2>
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for q in too_easy_questions %}
                    <tr>
                        <td>
                            <small>ID: {{ q.question_id }}</small><br>
                            {{ q.question_text }}
                        </td>
                        <td>
                            <span class="badge warning">{{ q.success_rate }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- Too Hard Questions -->
        {% if too_hard_questions %}
        <div class="analytics-section">
            <div class="section-header">
                <span class="section-icon">üò∞</span>
                <h2 class="section-title">Questions Too Hard</h2>
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for q in too_hard_questions %}
                    <tr>
                        <td>
                            <small>ID: {{ q.question_id }}</small><br>
                            {{ q.question_text }}
                        </td>
                        <td>
                            <span class="badge danger">{{ q.success_rate }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    
    <!-- Completion Statistics -->
    {% if completion_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">‚úÖ</span>
            <h2 class="section-title">Completion & Engagement Statistics</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-label">Total Started</div>
                <div class="stat-value">{{ completion_stats.total_started }}</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Completed</div>
                <div class="stat-value">{{ completion_stats.completed }}</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">Incomplete</div>
                <div class="stat-value">{{ completion_stats.incomplete }}</div>
            </div>
            <div class="stat-card red">
                <div class="stat-label">Abandoned</div>
                <div class="stat-value">{{ completion_stats.abandoned }}</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">Drop-off Rate</div>
                <div class="stat-value">{{ completion_stats.drop_off_rate }}%</div>
            </div>
            <div class="stat-card teal">
                <div class="stat-label">Skipped Questions</div>
                <div class="stat-value">{{ completion_stats.skipped_questions_rate }}%</div>
            </div>
        </div>
        
        {% if completion_stats.retake_data %}
        <h3 style="margin-top: 30px;">Retake Performance Analysis</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Total Attempts</th>
                    <th>First Score (%)</th>
                    <th>Last Score (%)</th>
                    <th>Improvement</th>
                </tr>
            </thead>
            <tbody>
                {% for retake in completion_stats.retake_data %}
                <tr>
                    <td>{{ retake.user_id }}</td>
                    <td>{{ retake.attempts }}</td>
                    <td>{{ retake.first_score }}%</td>
                    <td>{{ retake.last_score }}%</td>
                    <td style="color: {% if retake.improvement > 0 %}#10b981{% elif retake.improvement < 0 %}#ef4444{% else %}#6b7280{% endif %}; font-weight: bold;">
                        {% if retake.improvement > 0 %}+{% endif %}{{ retake.improvement }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Proctoring Insights -->
    {% if proctoring_stats %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üîí</span>
            <h2 class="section-title">Proctoring & Security Insights</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-label">Total Events</div>
                <div class="stat-value">{{ proctoring_stats.total_events }}</div>
            </div>
            
            <div class="stat-card red">
                <div class="stat-label">High Severity</div>
                <div class="stat-value">{{ proctoring_stats.high_severity }}</div>
            </div>
            
            <div class="stat-card orange">
                <div class="stat-label">Medium Severity</div>
                <div class="stat-value">{{ proctoring_stats.medium_severity }}</div>
            </div>
            
            <div class="stat-card green">
                <div class="stat-label">Low Severity</div>
                <div class="stat-value">{{ proctoring_stats.low_severity }}</div>
            </div>
        </div>
        
        {% if proctoring_stats.common_issues %}
        <h3 style="margin-top: 20px;">Most Common Issues:</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event Type</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in proctoring_stats.common_issues %}
                <tr>
                    <td>{{ issue.type }}</td>
                    <td><strong>{{ issue.count }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Demographics -->
    {% if demographic_stats.age_stats or demographic_stats.gender_distribution %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üë•</span>
            <h2 class="section-title">Demographic Analysis</h2>
        </div>
        
        <div class="charts-grid">
            {% if charts.age_distribution %}
            <div class="chart-container">
                <h3>Age Distribution</h3>
                <img src="{{ charts.age_distribution }}" alt="Age Distribution">
            </div>
            {% endif %}
            
            {% if charts.gender_distribution %}
            <div class="chart-container">
                <h3>Gender Distribution</h3>
                <img src="{{ charts.gender_distribution }}" alt="Gender Distribution">
            </div>
            {% endif %}
        </div>
        
        {% if demographic_stats.age_stats %}
        <p style="margin-top: 20px;"><strong>Average Age:</strong> {{ demographic_stats.age_stats.average_age }} years</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Platform Statistics -->
    {% if platform_stats.device_distribution %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üíª</span>
            <h2 class="section-title">Platform & Device Statistics</h2>
        </div>
        
        <div class="distribution-grid">
            {% for device, count in platform_stats.device_distribution.items %}
            <div class="distribution-item">
                <div class="label">{{ device }}</div>
                <div class="value">{{ count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Reliability Metrics -->
    {% if reliability_metrics.cronbach_alpha %}
    <div class="analytics-section">
        <div class="section-header">
            <span class="section-icon">üéØ</span>
            <h2 class="section-title">Test Reliability Metrics</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card purple">
                <div class="stat-label">Cronbach's Alpha</div>
                <div class="stat-value">{{ reliability_metrics.cronbach_alpha }}</div>
                <div class="stat-description">{{ reliability_metrics.interpretation }}</div>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <h4 style="margin-bottom: 10px; color: #4a5568;">What is Cronbach's Alpha?</h4>
            <p style="color: #6b7280; line-height: 1.6;">
                Cronbach's Alpha is a measure of internal consistency reliability. It indicates how well the test items measure the same construct.
                <br><br>
                <strong>Interpretation:</strong><br>
                ‚Ä¢ Œ± ‚â• 0.9: Excellent reliability<br>
                ‚Ä¢ 0.8 ‚â§ Œ± < 0.9: Good reliability<br>
                ‚Ä¢ 0.7 ‚â§ Œ± < 0.8: Acceptable reliability<br>
                ‚Ä¢ 0.6 ‚â§ Œ± < 0.7: Questionable reliability<br>
                ‚Ä¢ Œ± < 0.6: Poor reliability (test needs revision)
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- Empty State -->
    {% if not basic_stats or basic_stats.total_attempts == 0 %}
    <div class="analytics-section">
        <div class="empty-state">
            <div class="icon">üìä</div>
            <h3>No Data Available</h3>
            <p>There are no completed test attempts to analyze yet. Start by having candidates take tests!</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-submit form when filters change (optional)
document.querySelectorAll('.filter-form select, .filter-form input').forEach(element => {
    element.addEventListener('change', function() {
        // Uncomment below to enable auto-submit
        this.form.submit();
    });
});

// Add any chart.js initialization if needed
const trendData = {{ trend_data|safe }};
</script>
{% endblock %}